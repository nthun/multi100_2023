---
title: "Multi100_Huijts_EurSocioRev_2013_OY3B"
output: html_document
date: "`r Sys.Date()`"
editor_options: 
  chunk_output_type: console
---

# Hypotesis to analyze

_The disadvantage in psychological well-being of childless people is smaller in countries with tolerant norms towards childlessness (p. 32)_

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(readxl)
library(lmerTest)
library(broom)
library(broom.mixed)
library(ggbeeswarm)
library(performance)
library(sjPlot)

theme_set(theme_light())

```

```{r}
edu_levels <- c("Primary", "Lower secondary", "Upper secondary", "Teritary", "Missing")

wb <- 
  read_csv(here("data/SRD Huijts data final.xls")) %>% 
  mutate(gender = recode(gndr, `1` = "Male", `2` = "Female"),
         # Create centered age (to avoid multicollinearity) and age^2
         age_ctd = scale(agea, scale = FALSE) %>% as.numeric(),
         age_ctd2 = age_ctd^2,
         # Set education baseline to Primary, set explicit NA
         edu = fct_explicit_na(edu, na_level = "Missing") %>% 
               fct_relevel(edu_levels),
         paredu = fct_relevel(paredu, edu_levels),
         # Set parental status baseline to living with children
         # par_stat = fct_relevel(par_stat, "Living w children")
         )
```


```{r}
# Separate linear regressions by country by gender
wb_lm <- 
  wb %>% 
  group_by(country = cntry, gender) %>% 
  nest() %>% 
  mutate(model = map(data, 
                      ~lm(wellbeing ~ par_stat + age_ctd + age_ctd2 + married + edu + paredu + rel + pdwrk + brncntr,
                          data = .x)),
         model_tidy = map(model, tidy, conf.int = TRUE))

wb_lm %>% 
  unnest(model_tidy) %>% 
  filter(term %in% c("par_statLiving w children", "par_statEmpty nest")) %>% 
  select(-model, -data) %>% 
  ggplot() +
  aes(x = term, y = estimate, group = interaction(term, gender), fill = gender) +
  geom_quasirandom(dodge.width = .5, alpha = .5) +
  geom_boxplot(position = position_dodge(), alpha = .5, outlier.alpha = 0) +
  geom_text(aes(label = country), position = position_dodge(.5), check_overlap = TRUE, hjust = 0)
  

```

```{r}
wb_lmer <- 
  wb %>% 
  # select(wellbeing,
  #        Age = age_ctd, 
  #        `Age square` = age_ctd2,
  #        `Marital status` = married,
  #        `Educational level` = edu,
  #        `Educational level of parents` = paredu,
  #        `Religious attendance` = rel,
  #        `Paid employment` = pdwrk,
  #        `Born in country` = brncntr,
  #        `Parental status` = par_stat,
  #        Country = cntry,
  #        `Disapproval of childlessness` = childless_disapp_std,
  #        `Social contacts` = sclmeet) %>% 
  group_by(gender) %>% 
  nest() %>% 
  mutate(model = map(data, 
                     ~lmer(
                       wellbeing ~ age_ctd + age_ctd2 + married + edu + paredu + 
                                   rel + pdwrk + brncntr + sclmeet + 
                                   par_stat * childless_disapp_std + 
                                   (1 + par_stat| cntry),
                       data = .x)), 
         model_tidy = map(model, tidy, conf.int = TRUE))

term_order <- c(1:11, 13, 15, 16:22, 12, 14)

wb_lmer %>% 
  pull(model) %>% 
  set_names(pull(wb_lmer, gender)) %>% 
  tab_model(
          dv.labels = c("Male", "Female"),
          show.std = TRUE,
          show.est = FALSE,
          # show.se = TRUE,
          show.reflvl = TRUE, 
          show.ci = FALSE,
          # order.terms = term_order,
          show.aic = TRUE,
          show.dev = TRUE,
          prefix.labels = "varname")

isSingular(wb_lmer$model[[1]])
isSingular(wb_lmer$model[[2]])


```

```{r}
test1 <- 
  lmer(wellbeing ~ age_ctd + age_ctd2 + married + edu + paredu + 
                   rel + pdwrk + brncntr + sclmeet + 
                   gender * par_stat * childless_disapp_std +
                   (1 + par_stat| cntry),
       data = wb)

summary(test1)
check_model(test1)
check_collinearity(test1)

tab_model(test1, 
          show.stat = TRUE, 
          show.std = TRUE, 
          show.est = FALSE,
          show.icc = TRUE, 
          show.aic = TRUE,
          show.reflvl = TRUE, 
          prefix.labels = "v"
          )

parameters::parameters(test1, standardize = "basic") %>% 
  print_html()

```

```{r}

# Recalculate age

wb %>% 
  count(pdwrk)
  
  
wb %>%   
  # Set education baseline to Primary, set explicit NA
  mutate(edu = fct_relevel(edu, edu_levels) %>% 
               fct_explicit_na(na_level = "Missing"),
         paredu = fct_relevel(paredu, edu_levels),
         # Set parental status baseline to living with children
         par_stat = fct_relevel(par_stat, "Living w children")) %>% 
  count(par_stat)



```

